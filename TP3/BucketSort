import numpy as np
from mpi4py import MPI
from scipy.stats import norm
import time

comm = MPI.COMM_WORLD
rank = comm.Get_rank()
size = comm.Get_size()

total_len = 60
local_len = total_len // size 

def normal_alltoall_sort():
    local_data = np.random.standard_normal(local_len).tolist()
    
    send_buckets = [[] for _ in range(size)]
    
    for val in local_data:
        # Finding each percentiles, defining each rank and assigning eaech bucket
        percentile = norm.cdf(val)
        dest_rank = int(percentile * size)
        
        if dest_rank >= size:
            dest_rank = size - 1
        send_buckets[dest_rank].append(val)
    
    # Exchange data
    received_buckets = comm.alltoall(send_buckets)
    
    # Local Sort
    local_final_bucket = [item for sublist in received_buckets for item in sublist]
    local_final_bucket.sort()
    
    # Gather to see the final result
    all_sorted_data = comm.gather(local_final_bucket, root=0)
    
    if rank == 0:
        final_array = [val for sublist in all_sorted_data if sublist for val in sublist]
        print(f"Sorted Normal Array: {[round(x, 3) for x in final_array]}")

start = time.time()
normal_alltoall_sort()
end = time.time()

if rank == 0:
    print(f"Total time: {(end - start)*1000:.2f} ms")
